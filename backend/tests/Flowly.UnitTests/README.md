# Flowly Backend Unit Tests

Цей проект містить unit тести для backend сервісів Flowly.

## Технології

- **xUnit** - фреймворк для тестування
- **Moq** - бібліотека для створення моків
- **FluentAssertions** - для виразних assertions
- **SQLite In-Memory** - для ізольованого тестування бази даних

## Структура тестів

### AuthServiceTests
Тести для автентифікації та авторизації:
- ✅ Успішна реєстрація користувача
- ✅ Захист від дублювання email
- ✅ Логін з неправильним паролем
- ✅ Логін з правильними credentials
- ✅ Refresh token - прострочений токен
- ✅ Refresh token - відкликаний токен
- ✅ Успішне оновлення токену
- ✅ Зміна пароля відкликає всі токени
- ✅ Неможливість використати чужий refresh token

**Фокус на безпеці:**
- Паролі хешуються, не зберігаються в plain text
- IP адреси зберігаються для аудиту
- Токени автоматично відкликаються при зміні пароля
- Захист від session hijacking

### NoteServiceTests
Тести для роботи з нотатками:
- ✅ Створення нотатки з валідними даними
- ✅ Створення нотатки з тегами
- ✅ Неможливість використати чужі теги
- ✅ Валідація обов'язкових полів
- ✅ Архівування нотатки
- ✅ Фільтрація нотаток за тегами
- ✅ Фільтрація за текстовим пошуком
- ✅ Ізоляція даних між користувачами
- ✅ Неможливість отримати чужу нотатку по ID
- ✅ Фільтрація архівованих нотаток
- ✅ Оновлення нотатки оновлює timestamp
- ✅ Неможливість оновити чужу нотатку
- ✅ Пагінація працює коректно

**Фокус на безпеці:**
- Користувач бачить тільки свої нотатки
- Неможливо отримати/змінити чужі дані навіть знаючи ID
- Теги ізольовані між користувачами

### TaskServiceTests
Тести для роботи з задачами:
- ✅ Переміщення задачі між темами
- ✅ Переміщення задачі в null theme (unassigned)
- ✅ Неможливість перемістити задачу в чужу тему
- ✅ Створення recurring task (щоденна)
- ✅ Завершення recurring task створює нову
- ✅ Recurring task з тижневим інтервалом
- ✅ Додавання subtask до задачі
- ✅ Порядок subtasks зберігається
- ✅ Toggle subtask змінює статус
- ✅ Неможливість додати subtask до чужої задачі
- ✅ Recurring task клонує subtasks
- ✅ Видалення subtask
- ✅ Оновлення задачі оновлює UpdatedAt
- ✅ Неможливість оновити чужу задачу

**Фокус на складній логіці:**
- Правильна робота recurring tasks (daily, weekly)
- Клонування subtasks при створенні наступної recurring task
- Збереження порядку елементів

### FinanceServiceTests
Тести для фінансових операцій:
- ✅ Створення транзакції з валідними даними
- ✅ Валідація суми транзакції
- ✅ Перевірка budget overspent
- ✅ Income зменшує spent в бюджеті
- ✅ Обчислення статистики за період
- ✅ Статистика по категоріях з відсотками
- ✅ Неможливість використати чужу категорію
- ✅ Неможливість прив'язати до чужого бюджету
- ✅ Транзакції різних користувачів ізольовані
- ✅ Валідація валюти бюджету та транзакції
- ✅ Архівовані транзакції не враховуються в бюджеті
- ✅ Середні витрати за день
- ✅ Неможливість отримати чужий бюджет
- ✅ Транзакції поза періодом бюджету не враховуються

**Фокус на точності обчислень:**
- Правильний розрахунок витрат і доходів
- Коректна робота з різними валютами
- Точна статистика по категоріях з відсотками
- Правильна обробка періодів бюджету

## Запуск тестів

### Запустити всі тести
```bash
dotnet test
```

### Запустити тести з детальним виводом
```bash
dotnet test --logger "console;verbosity=detailed"
```

### Запустити тести конкретного класу
```bash
dotnet test --filter "FullyQualifiedName~AuthServiceTests"
```

### Запустити конкретний тест
```bash
dotnet test --filter "FullyQualifiedName~RegisterAsync_WithValidData_ShouldCreateUserAndReturnTokens"
```

### Запустити з покриттям коду
```bash
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
```

## Helpers

### TestDbContextFactory
Створює ізольований SQLite In-Memory контекст для кожного тесту:
- `CreateInMemoryContext()` - створює AppDbContext
- `CreateUserManager()` - створює UserManager для тестування
- `CreateSignInManager()` - створює SignInManager для тестування

### TestDataSeeder
Допоміжні методи для створення тестових даних:
- `CreateTestUserAsync()` - створює тестового користувача
- `CreateTestTagsAsync()` - створює теги
- `CreateTestCategoriesAsync()` - створює категорії
- `CreateTestCurrencyAsync()` - створює валюту
- `CreateTestTaskThemeAsync()` - створює тему для задач
- `CreateTestBudgetAsync()` - створює бюджет

## Принципи тестування

1. **Ізоляція** - кожен тест має свою власну in-memory базу даних
2. **Безпека** - особлива увага приділяється тестуванню захисту даних
3. **Реальні сценарії** - тести покривають реальні use cases, а не просто HTTP статуси
4. **Чіткі коментарі** - кожен тест має пояснення що і чому тестується
5. **AAA Pattern** - Arrange, Act, Assert для структурованості

## Покриття

Тести покривають:
- ✅ Бізнес-логіку сервісів
- ✅ Валідацію даних
- ✅ Захист від несанкціонованого доступу
- ✅ Ізоляцію даних між користувачами
- ✅ Складні сценарії (recurring tasks, budget calculations)
- ✅ Edge cases (прострочені токени, порожні поля, тощо)
