# Makefile –¥–ª—è Flowly –ø—Ä–æ—î–∫—Ç—É
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: make [command]

.PHONY: help dev db-up db-down migrate seed clean test docker-up docker-down docker-rebuild

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
GREEN  := $(shell tput -Txterm setaf 2)
YELLOW := $(shell tput -Txterm setaf 3)
WHITE  := $(shell tput -Txterm setaf 7)
CYAN   := $(shell tput -Txterm setaf 6)
RESET  := $(shell tput -Txterm sgr0)

help: ## –ü–æ–∫–∞–∑–∞—Ç–∏ —Ü–µ –º–µ–Ω—é
	@echo ''
	@echo '${CYAN}Flowly - Routine Organizer${RESET}'
	@echo ''
	@echo 'Usage:'
	@echo '  ${YELLOW}make${RESET} ${GREEN}<target>${RESET}'
	@echo ''
	@echo 'Targets:'
	@awk 'BEGIN {FS = ":.*?## "} { \
		if (/^[a-zA-Z_-]+:.*?##.*$$/) {printf "  ${YELLOW}%-20s${GREEN}%s${RESET}\n", $$1, $$2} \
		else if (/^## .*$$/) {printf "  ${CYAN}%s${RESET}\n", substr($$1,4)} \
		}' $(MAKEFILE_LIST)

## Development
dev: ## –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø—Ä–æ—î–∫—Ç –ª–æ–∫–∞–ª—å–Ω–æ (backend + frontend + db)
	@echo "${GREEN}üöÄ Starting Flowly in development mode...${RESET}"
	@make db-up
	@sleep 2
	@echo "${YELLOW}Starting backend...${RESET}"
	@cd backend && dotnet watch run --project src/Flowly.Api/Flowly.Api.csproj &
	@echo "${YELLOW}Starting frontend...${RESET}"
	@cd frontend && npm start

dev-backend: ## –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ backend
	@echo "${GREEN}üîß Starting backend...${RESET}"
	@cd backend && dotnet watch run --project src/Flowly.Api/Flowly.Api.csproj

dev-frontend: ## –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ frontend
	@echo "${GREEN}üé® Starting frontend...${RESET}"
	@cd frontend && npm start

## Database
db-up: ## –ü—ñ–¥–Ω—è—Ç–∏ PostgreSQL + pgAdmin
	@echo "${GREEN}üêò Starting PostgreSQL...${RESET}"
	@docker-compose up -d db pgadmin

db-down: ## –ó—É–ø–∏–Ω–∏—Ç–∏ –ë–î
	@echo "${YELLOW}‚èπÔ∏è  Stopping database...${RESET}"
	@docker-compose down

db-reset: ## –í–∏–¥–∞–ª–∏—Ç–∏ –ë–î —ñ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–Ω–æ–≤–æ (–í–ò–î–ê–õ–ò–¢–¨ –í–°–Ü –î–ê–ù–Ü!)
	@echo "${YELLOW}‚ö†Ô∏è  This will DELETE all data! Press Ctrl+C to cancel...${RESET}"
	@sleep 3
	@docker-compose down -v
	@make db-up
	@sleep 3
	@make migrate
	@make seed

## Migrations
migrate: ## –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ Docker
	@chmod +x ../tools/apply-migrations.sh
	@../tools/apply-migrations.sh

migrate-add: ## –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –º—ñ–≥—Ä–∞—Ü—ñ—é (use: make migrate-add name=MigrationName)
	@if [ -z "$(name)" ]; then \
		echo "${YELLOW}‚ùå –ü–æ–º–∏–ª–∫–∞: –í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É –º—ñ–≥—Ä–∞—Ü—ñ—ó${RESET}"; \
		echo "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: make migrate-add name=–ù–∞–∑–≤–∞–ú—ñ–≥—Ä–∞—Ü—ñ—ó"; \
		exit 1; \
	fi
	@chmod +x ../tools/create-migration.sh
	@../tools/create-migration.sh $(name)

migrate-remove: ## –í–∏–¥–∞–ª–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é –º—ñ–≥—Ä–∞—Ü—ñ—é
	@echo "${YELLOW}üóëÔ∏è  Removing last migration...${RESET}"
	@cd ../backend/src/Flowly.Infrastructure && \
		dotnet ef migrations remove --startup-project ../Flowly.Api/Flowly.Api.csproj --context AppDbContext

migrate-list: ## –ü–æ–∫–∞–∑–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –º—ñ–≥—Ä–∞—Ü—ñ–π
	@cd ../backend/src/Flowly.Infrastructure && \
		dotnet ef migrations list --startup-project ../Flowly.Api/Flowly.Api.csproj --context AppDbContext

seed: ## –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –ë–î –ø–æ—á–∞—Ç–∫–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏
	@chmod +x tools/seed.sh
	@./tools/seed.sh

## Testing
test: ## –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ç–µ—Å—Ç–∏
	@echo "${GREEN}üß™ Running tests...${RESET}"
	@cd backend && dotnet test
	@cd frontend && npm test

test-backend: ## –¢–µ—Å—Ç–∏ backend
	@echo "${GREEN}üß™ Running backend tests...${RESET}"
	@cd backend && dotnet test

test-frontend: ## –¢–µ—Å—Ç–∏ frontend
	@echo "${GREEN}üß™ Running frontend tests...${RESET}"
	@cd frontend && npm test

## Docker (Production)
docker-up: ## –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –í–°–ï —á–µ—Ä–µ–∑ Docker (production mode)
	@echo "${GREEN}üê≥ Starting all services in Docker...${RESET}"
	@docker-compose up -d --build

docker-down: ## –ó—É–ø–∏–Ω–∏—Ç–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
	@echo "${YELLOW}‚èπÔ∏è  Stopping Docker containers...${RESET}"
	@docker-compose down

docker-rebuild: ## Rebuild Docker images
	@echo "${GREEN}üî® Rebuilding Docker images...${RESET}"
	@docker-compose build --no-cache

docker-logs: ## –ü–æ–∫–∞–∑–∞—Ç–∏ –ª–æ–≥–∏ Docker
	@docker-compose logs -f

## Cleanup
clean: ## –û—á–∏—Å—Ç–∏—Ç–∏ build –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏
	@echo "${YELLOW}üßπ Cleaning build artifacts...${RESET}"
	@find backend -type d -name "bin" -o -name "obj" | xargs rm -rf
	@rm -rf frontend/dist frontend/.angular frontend/node_modules/.cache

clean-all: clean ## –û—á–∏—Å—Ç–∏—Ç–∏ –í–°–ï (–≤–∫–ª—é—á–Ω–æ –∑ node_modules)
	@echo "${YELLOW}üßπ Deep cleaning...${RESET}"
	@rm -rf frontend/node_modules
	@rm -rf backend/src/*/bin backend/src/*/obj

## Build
build: ## Build –ø—Ä–æ—î–∫—Ç—É
	@echo "${GREEN}üî® Building backend...${RESET}"
	@cd backend && dotnet build
	@echo "${GREEN}üî® Building frontend...${RESET}"
	@cd frontend && npm run build

## Install
install: ## –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
	@echo "${GREEN}üì¶ Installing backend dependencies...${RESET}"
	@cd backend && dotnet restore
	@echo "${GREEN}üì¶ Installing frontend dependencies...${RESET}"
	@cd frontend && npm install --legacy-peer-deps

## Backup
backup: ## –°—Ç–≤–æ—Ä–∏—Ç–∏ backup –ë–î
	@echo "${GREEN}üíæ Creating database backup...${RESET}"
	@mkdir -p backups
	@docker exec flowly-db pg_dump -U $(POSTGRES_USER) $(POSTGRES_DB) > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "${GREEN}‚úÖ Backup created in backups/${RESET}"

restore: ## –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –ë–î –∑ backup (use: make restore file=backup.sql)
	@echo "${YELLOW}üì• Restoring database from $(file)...${RESET}"
	@docker exec -i flowly-db psql -U $(POSTGRES_USER) $(POSTGRES_DB) < $(file)
	@echo "${GREEN}‚úÖ Database restored${RESET}"

## Info
status: ## –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤—ñ—Å—ñ–≤
	@echo "${CYAN}üìä Services Status:${RESET}"
	@docker-compose ps

logs: ## –ü–æ–∫–∞–∑–∞—Ç–∏ –ª–æ–≥–∏ –ë–î
	@docker-compose logs -f db

info: ## –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø—Ä–æ—î–∫—Ç
	@echo "${CYAN}‚ÑπÔ∏è  Flowly Project Info${RESET}"
	@echo ""
	@echo "${YELLOW}Backend:${RESET}"
	@cd backend && dotnet --version
	@echo ""
	@echo "${YELLOW}Frontend:${RESET}"
	@cd frontend && node --version && npm --version
	@echo ""
	@echo "${YELLOW}Docker:${RESET}"
	@docker --version
	@docker-compose --version