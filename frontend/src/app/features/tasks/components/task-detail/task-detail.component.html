<div class="container" *ngIf="task; else loadingTpl">
  
  <header class="page-header">
    <div class="header-left">
      <a routerLink="/tasks" class="btn-back">
        <i class="bi bi-arrow-left"></i>
        <span>{{ 'TASKS.DETAIL.BACK' | translate }}</span>
      </a>
      <h1>{{ 'TASKS.DETAIL.TITLE' | translate }}</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="editTask()">
        <i class="bi bi-pencil"></i> {{ 'TASKS.DETAIL.EDIT' | translate }}
      </button>
    </div>
  </header>

  <section class="detail-content">
    
    <div class="detail-card main-card">
      <div class="task-header">
        <h2 class="task-title">{{ task.title }}</h2>
        <div class="task-meta">
          <span class="badge status-badge" [style.background-color]="getStatusColor(task.status)">
            {{ getStatusIcon(task.status) }} {{ 'TASKS.STATUS.' + task.status.toUpperCase() | translate }}
          </span>
          <span class="badge priority-badge" [style.color]="getPriorityColor(task.priority)">
            {{ getPriorityIcon(task.priority) }} {{ 'TASKS.PRIORITY.' + task.priority.toUpperCase() | translate }}
          </span>
        </div>
      </div>

      <div class="task-properties">
        
        <div class="property-card" *ngIf="task.dueDate">
          <div class="property-icon calendar-icon">
            <svg width="24" height="24" viewBox="0 0 20 20" fill="none">
              <path d="M6 2v2M14 2v2M3 7h14M5 11h2v2H5v-2z" stroke="currentColor" stroke-width="1.5"
                stroke-linecap="round" stroke-linejoin="round" />
              <rect x="3" y="5" width="14" height="12" rx="2" stroke="currentColor" stroke-width="1.5" />
            </svg>
          </div>
          <div class="property-content">
            <label>{{ 'TASKS.DETAIL.DUE_DATE' | translate }}</label>
            <div class="value">{{ formatDate(task.dueDate) }}</div>
          </div>
        </div>

        <div class="property-card" *ngIf="task.theme">
          <div class="property-icon theme-icon">
            <svg width="24" height="24" viewBox="0 0 20 20" fill="none">
              <path d="M7 3h6l4 4v10H3V7l4-4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 3v4h6V3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="property-content">
            <label>{{ 'TASKS.DETAIL.THEME' | translate }}</label>
            <div class="value theme-value">
              <span class="theme-indicator" [style.background-color]="task.theme.color"></span>
              {{ task.theme.title }}
            </div>
          </div>
        </div>
      </div>

      <div class="recurrence-section" *ngIf="task.recurrence">
        <div class="recurrence-header">
          <div class="recurrence-icon">
            <svg width="24" height="24" viewBox="0 0 20 20" fill="none">
              <path d="M4 7h10M4 7l3-3M4 7l3 3M16 13H6M16 13l-3 3M16 13l-3-3" stroke="currentColor" stroke-width="1.8"
                stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </div>
          <div class="recurrence-content">
            <h3>{{ 'TASKS.DETAIL.RECURRENCE.TITLE' | translate }}</h3>
            <p class="recurrence-description">{{ getRecurrenceDescription() }}</p>
          </div>
        </div>
        <div class="recurrence-details">
          <div class="recurrence-detail-item" *ngIf="task.recurrence.lastOccurrence">
            <span class="detail-label">{{ 'TASKS.DETAIL.RECURRENCE.LAST_OCCURRENCE' | translate }}</span>
            <span class="detail-value">{{ formatRecurrenceDate(task.recurrence.lastOccurrence) }}</span>
          </div>
          <div class="recurrence-detail-item" *ngIf="task.recurrence.nextOccurrence">
            <span class="detail-label">{{ 'TASKS.DETAIL.RECURRENCE.NEXT_OCCURRENCE' | translate }}</span>
            <span class="detail-value next-date">{{ formatRecurrenceDate(task.recurrence.nextOccurrence) }}</span>
          </div>
          <div class="recurrence-detail-item">
            <span class="detail-label">{{ 'TASKS.DETAIL.RECURRENCE.PATTERN' | translate }}</span>
            <span class="detail-value">{{ getRecurrenceDescription() }}</span>
          </div>
        </div>
      </div>

      <div class="description-section" *ngIf="task.description">
        <div class="section-header">
          <div class="section-icon">
            <svg width="24" height="24" viewBox="0 0 20 20" fill="none">
              <path d="M4 4h12M4 8h12M4 12h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </div>
          <h3>{{ 'TASKS.DETAIL.DESCRIPTION' | translate }}</h3>
        </div>
        <div class="markdown-content" [innerHTML]="renderMarkdown(task.description)"></div>
      </div>

      <div class="info-section">
        <h3>{{ 'TASKS.DETAIL.SUBTASKS' | translate:{count: task.subtasks.length} }}</h3>

        <div class="subtasks-list" *ngIf="task.subtasks.length > 0">
          <div class="subtask-item" *ngFor="let sub of task.subtasks; let i = index" (click)="toggleSubtask(i)">
            <div class="checkbox" [class.checked]="sub.isDone">
              <i class="bi bi-check" *ngIf="sub.isDone"></i>
            </div>
            <span class="subtask-title" [class.completed]="sub.isDone">{{ sub.title }}</span>
          </div>
        </div>
        <div class="empty-state" *ngIf="task.subtasks.length === 0">
          {{ 'TASKS.DETAIL.NO_SUBTASKS' | translate }}
        </div>
      </div>

      <div class="tags-section" *ngIf="task.tags && task.tags.length > 0">
        <div class="section-header">
          <div class="section-icon">
            <svg width="24" height="24" viewBox="0 0 20 20" fill="none">
              <path d="M3 10l7-7 7 7M10 3v14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="10" cy="6" r="1.5" fill="currentColor"/>
            </svg>
          </div>
          <h3>{{ 'TASKS.DETAIL.TAGS' | translate }}</h3>
        </div>
        <div class="tags-grid">
          <div class="tag-card" *ngFor="let tag of task.tags">
            <span class="tag-indicator" [style.background-color]="tag.color"></span>
            <span class="tag-name">{{ tag.name }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="detail-card linked-card"
      *ngIf="linkedNotes.length > 0 || linkedTasks.length > 0 || linkedTransactions.length > 0">
      <h3>
        <i class="bi bi-link-45deg"></i>
        {{ 'TASKS.DETAIL.LINKED_ITEMS' | translate }}
      </h3>

      <div class="linked-sections">
        
        <div class="linked-section" *ngIf="linkedNotes.length > 0">
          <div class="section-header">
            <i class="bi bi-journal-text"></i>
            <span>{{ 'TASKS.DETAIL.LINKED_NOTES' | translate }}</span>
            <span class="badge">{{ linkedNotes.length }}</span>
          </div>
          <div class="link-items">
            <a *ngFor="let note of linkedNotes" [routerLink]="['/notes', note.id]" class="link-item">
              <div class="link-icon note-icon">
                <i class="bi bi-journal-text"></i>
              </div>
              <div class="link-content">
                <div class="link-title">{{ note.title }}</div>
                <div class="link-snippet" *ngIf="note.snippet">{{ note.snippet }}</div>
              </div>
              <div class="link-arrow">
                <i class="bi bi-chevron-right"></i>
              </div>
            </a>
          </div>
        </div>

        <div class="linked-section" *ngIf="linkedTasks.length > 0">
          <div class="section-header">
            <i class="bi bi-check-circle"></i>
            <span>{{ 'TASKS.DETAIL.LINKED_TASKS' | translate }}</span>
            <span class="badge">{{ linkedTasks.length }}</span>
          </div>
          <div class="link-items">
            <a *ngFor="let t of linkedTasks" [routerLink]="['/tasks', t.id]" class="link-item">
              <div class="link-icon task-icon">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="link-content">
                <div class="link-title">{{ t.title }}</div>
                <div class="link-snippet" *ngIf="t.snippet">{{ t.snippet }}</div>
              </div>
              <div class="link-arrow">
                <i class="bi bi-chevron-right"></i>
              </div>
            </a>
          </div>
        </div>

        <div class="linked-section" *ngIf="linkedTransactions.length > 0">
          <div class="section-header">
            <i class="bi bi-currency-dollar"></i>
            <span>{{ 'TASKS.DETAIL.LINKED_TRANSACTIONS' | translate }}</span>
            <span class="badge">{{ linkedTransactions.length }}</span>
          </div>
          <div class="link-items">
            <a *ngFor="let tx of linkedTransactions" [routerLink]="['/finance/transactions', tx.id]" class="link-item">
              <div class="link-icon transaction-icon">
                <i class="bi bi-currency-dollar"></i>
              </div>
              <div class="link-content">
                <div class="link-title">{{ tx.title }}</div>
                <div class="link-snippet" *ngIf="tx.snippet">{{ tx.snippet }}</div>
              </div>
              <div class="link-arrow">
                <i class="bi bi-chevron-right"></i>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>

  </section>

  <footer>
    <div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>
    
    <div class="detail-footer">
      <p>{{ 'TASKS.DETAIL.LAST_UPDATED' | translate:{date: formatDate(task.updatedAt)} }}</p>
    </div>
  </footer>
</div>

<ng-template #loadingTpl>
  <div class="loading">{{ 'TASKS.DETAIL.LOADING' | translate }}</div>
</ng-template>
