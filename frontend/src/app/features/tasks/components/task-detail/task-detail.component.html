<div class="container" *ngIf="task; else loadingTpl">
  <!-- Header -->
  <header class="page-header">
    <div class="header-left">
      <a routerLink="/tasks" class="btn-back">
        <i class="bi bi-arrow-left"></i>
        <span>{{ 'TASKS.DETAIL.BACK' | translate }}</span>
      </a>
      <h1>{{ 'TASKS.DETAIL.TITLE' | translate }}</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="editTask()">
        <i class="bi bi-pencil"></i> {{ 'TASKS.DETAIL.EDIT' | translate }}
      </button>
    </div>
  </header>

  <section class="detail-content">
    <!-- Main Info Card -->
    <div class="detail-card main-card">
      <div class="task-header">
        <h2 class="task-title">{{ task.title }}</h2>
        <div class="task-meta">
          <span class="badge status-badge" [style.background-color]="getStatusColor(task.status)">
            {{ getStatusIcon(task.status) }} {{ 'TASKS.STATUS.' + task.status.toUpperCase() | translate }}
          </span>
          <span class="badge priority-badge" [style.color]="getPriorityColor(task.priority)">
            {{ getPriorityIcon(task.priority) }} {{ 'TASKS.PRIORITY.' + task.priority.toUpperCase() | translate }}
          </span>
        </div>
      </div>

      <div class="task-properties">
        <!-- Due Date -->
        <div class="property-item" *ngIf="task.dueDate">
          <label>{{ 'TASKS.DETAIL.DUE_DATE' | translate }}</label>
          <div class="value">
            <i class="bi bi-calendar"></i> {{ formatDate(task.dueDate) }}
          </div>
        </div>

        <!-- Theme -->
        <div class="property-item" *ngIf="task.theme">
          <label>{{ 'TASKS.DETAIL.THEME' | translate }}</label>
          <div class="value theme-value">
            <span class="theme-dot" [style.background-color]="task.theme.color"></span>
            {{ task.theme.title }}
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="info-section" *ngIf="task.description">
        <h3>{{ 'TASKS.DETAIL.DESCRIPTION' | translate }}</h3>
        <div class="markdown-content" [innerHTML]="renderMarkdown(task.description)"></div>
      </div>

      <!-- Subtasks -->
      <div class="info-section">
        <h3>{{ 'TASKS.DETAIL.SUBTASKS' | translate:{count: task.subtasks.length} }}</h3>

        <div class="subtasks-list" *ngIf="task.subtasks.length > 0">
          <div class="subtask-item" *ngFor="let sub of task.subtasks; let i = index" (click)="toggleSubtask(i)">
            <div class="checkbox" [class.checked]="sub.isDone">
              <i class="bi bi-check" *ngIf="sub.isDone"></i>
            </div>
            <span class="subtask-title" [class.completed]="sub.isDone">{{ sub.title }}</span>
          </div>
        </div>
        <div class="empty-state" *ngIf="task.subtasks.length === 0">
          {{ 'TASKS.DETAIL.NO_SUBTASKS' | translate }}
        </div>
      </div>

      <!-- Tags -->
      <div class="info-section" *ngIf="task.tags && task.tags.length > 0">
        <h3>{{ 'TASKS.DETAIL.TAGS' | translate }}</h3>
        <div class="tags-list">
          <span class="tag" *ngFor="let tag of task.tags" [style.background-color]="tag.color">
            {{ tag.name }}
          </span>
        </div>
      </div>
    </div>

    <!-- Linked Items -->
    <div class="detail-card linked-card"
      *ngIf="linkedNotes.length > 0 || linkedTasks.length > 0 || linkedTransactions.length > 0">
      <h3>
        <i class="bi bi-link-45deg"></i>
        {{ 'TASKS.DETAIL.LINKED_ITEMS' | translate }}
      </h3>

      <div class="linked-sections">
        <!-- Linked Notes -->
        <div class="linked-section" *ngIf="linkedNotes.length > 0">
          <div class="section-header">
            <i class="bi bi-journal-text"></i>
            <span>{{ 'TASKS.DETAIL.LINKED_NOTES' | translate }}</span>
            <span class="badge">{{ linkedNotes.length }}</span>
          </div>
          <div class="link-items">
            <a *ngFor="let note of linkedNotes" [routerLink]="['/notes', note.id]" class="link-item">
              <div class="link-icon note-icon">
                <i class="bi bi-journal-text"></i>
              </div>
              <div class="link-content">
                <div class="link-title">{{ note.title }}</div>
                <div class="link-snippet" *ngIf="note.snippet">{{ note.snippet }}</div>
              </div>
              <div class="link-arrow">
                <i class="bi bi-chevron-right"></i>
              </div>
            </a>
          </div>
        </div>

        <!-- Linked Tasks -->
        <div class="linked-section" *ngIf="linkedTasks.length > 0">
          <div class="section-header">
            <i class="bi bi-check-circle"></i>
            <span>{{ 'TASKS.DETAIL.LINKED_TASKS' | translate }}</span>
            <span class="badge">{{ linkedTasks.length }}</span>
          </div>
          <div class="link-items">
            <a *ngFor="let t of linkedTasks" [routerLink]="['/tasks', t.id]" class="link-item">
              <div class="link-icon task-icon">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="link-content">
                <div class="link-title">{{ t.title }}</div>
                <div class="link-snippet" *ngIf="t.snippet">{{ t.snippet }}</div>
              </div>
              <div class="link-arrow">
                <i class="bi bi-chevron-right"></i>
              </div>
            </a>
          </div>
        </div>

        <!-- Linked Transactions -->
        <div class="linked-section" *ngIf="linkedTransactions.length > 0">
          <div class="section-header">
            <i class="bi bi-currency-dollar"></i>
            <span>{{ 'TASKS.DETAIL.LINKED_TRANSACTIONS' | translate }}</span>
            <span class="badge">{{ linkedTransactions.length }}</span>
          </div>
          <div class="link-items">
            <a *ngFor="let tx of linkedTransactions" [routerLink]="['/finance/transactions', tx.id]" class="link-item">
              <div class="link-icon transaction-icon">
                <i class="bi bi-currency-dollar"></i>
              </div>
              <div class="link-content">
                <div class="link-title">{{ tx.title }}</div>
                <div class="link-snippet" *ngIf="tx.snippet">{{ tx.snippet }}</div>
              </div>
              <div class="link-arrow">
                <i class="bi bi-chevron-right"></i>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>

  </section>

  <footer>
    <div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>
    <!-- Footer Info -->
    <div class="detail-footer">
      <p>{{ 'TASKS.DETAIL.LAST_UPDATED' | translate:{date: formatDate(task.updatedAt)} }}</p>
    </div>
  </footer>
</div>

<ng-template #loadingTpl>
  <div class="loading">{{ 'TASKS.DETAIL.LOADING' | translate }}</div>
</ng-template>