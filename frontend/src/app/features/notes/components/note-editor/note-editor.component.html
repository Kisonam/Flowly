<!-- frontend/src/app/features/notes/components/note-editor/note-editor.component.html -->

<div class="note-editor-container">
  <!-- Header -->
  <div class="editor-header">
    <div class="header-left">
      <button type="button" class="btn-back" (click)="onCancel()" [title]="'NOTES.EDITOR.BACK_BUTTON' | translate">
        {{ 'NOTES.EDITOR.BACK_BUTTON' | translate }}
      </button>
      <h1 class="editor-title">
        {{ (isEditMode ? 'NOTES.EDITOR.TITLE_EDIT' : 'NOTES.EDITOR.TITLE_NEW') | translate }}
      </h1>
    </div>

    <div class="header-actions">
      <!-- First Row: Save Actions -->
      <div class="actions-row actions-primary">
        <button type="button" class="btn-secondary" (click)="onCancel()" [disabled]="isSaving">
          {{ 'NOTES.EDITOR.CANCEL' | translate }}
        </button>
        <button type="button" class="btn-primary" (click)="onSubmit()" [disabled]="noteForm.invalid || isSaving">
          <span *ngIf="!isSaving">{{ (isEditMode ? 'NOTES.EDITOR.UPDATE' : 'NOTES.EDITOR.CREATE') | translate }}</span>
          <span *ngIf="isSaving">‚è≥ {{ 'NOTES.EDITOR.SAVING' | translate }}</span>
        </button>
      </div>

      <!-- Second Row: View Mode Toggles -->
      <div class="actions-row actions-secondary">
        <button type="button" class="btn-secondary" [class.active]="isPreviewMode && !isSplitView"
          [attr.aria-label]="'NOTES.EDITOR.PREVIEW_MODE' | translate" (click)="togglePreview()"
          [title]="'NOTES.EDITOR.PREVIEW_MODE' | translate">
          {{ 'NOTES.EDITOR.PREVIEW_MODE' | translate }}
        </button>
        <button type="button" class="btn-secondary" [class.active]="isSplitView"
          [attr.aria-label]="'NOTES.EDITOR.SPLIT_MODE' | translate" (click)="toggleSplitView()"
          [title]="'NOTES.EDITOR.SPLIT_MODE' | translate">
          {{ 'NOTES.EDITOR.SPLIT_MODE' | translate }}
        </button>
        <button type="button" class="btn-secondary" [class.active]="!isPreviewMode && !isSplitView"
          [attr.aria-label]="'NOTES.EDITOR.EDITOR_MODE' | translate" (click)="isPreviewMode = false; isSplitView = false"
          [title]="'NOTES.EDITOR.EDITOR_MODE' | translate">
          {{ 'NOTES.EDITOR.EDITOR_MODE' | translate }}
        </button>

        <!-- Save Status -->
        <div class="save-status" *ngIf="lastSavedTime" role="status" aria-live="polite">
          ‚úÖ <span class="save-time">{{ 'NOTES.EDITOR.SAVED' | translate }} {{ lastSavedTime | date: 'short' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div class="alert alert-danger" *ngIf="errorMessage">
    <i class="bi bi-exclamation-triangle"></i>
    {{ errorMessage }}
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>{{ 'NOTES.EDITOR.LOADING' | translate }}</p>
  </div>

  <!-- Editor Content -->
  <div class="editor-content" *ngIf="!isLoading" [formGroup]="noteForm">
    <!-- Sidebar: Tags & Upload -->
    <aside class="editor-sidebar">
      <!-- Tags Section -->
      <div class="sidebar-section">
        <app-tag-manager [title]="'NOTES.EDITOR.TAGS_TITLE' | translate" [selectedIds]="selectedTagIds"
          (selectedIdsChange)="onTagsChanged($event)" (tagsUpdated)="loadAvailableTags()">
        </app-tag-manager>
      </div>

      <!-- Links Section -->
      <div class="sidebar-section">
        <h3 class="sidebar-title">
          <i class="bi bi-link-45deg"></i>
          {{ 'NOTES.EDITOR.LINKS_TITLE' | translate }}
        </h3>
        <div *ngIf="!noteId" class="info-message">
          üí° {{ 'NOTES.EDITOR.LINKS_INFO' | translate }}
        </div>
        <app-link-selector *ngIf="noteId" [entityType]="LinkEntityType.Note" [entityId]="noteId" [title]="''"
          (linkCreated)="onLinkCreated($event)" (linkDeleted)="onLinkDeleted($event)">
        </app-link-selector>
      </div>

      <!-- Upload Section -->
      <div class="sidebar-section">
        <h3 class="sidebar-title">
          <i class="bi bi-image"></i>
          {{ 'NOTES.EDITOR.IMAGES_TITLE' | translate }}
        </h3>

        <div class="drop-zone" [class.dragging]="isDragging" (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
          <i class="bi bi-cloud-upload drop-icon"></i>
          <p class="drop-text">{{ 'NOTES.EDITOR.DROP_TEXT' | translate }}</p>
          <p class="drop-subtext">{{ 'NOTES.EDITOR.DROP_SUBTEXT' | translate }}</p>
          <label class="btn-upload">
            <i class="bi bi-upload"></i>
            {{ 'NOTES.EDITOR.BROWSE_FILES' | translate }}
            <input type="file" accept="image/*" multiple (change)="onFileSelected($event)" style="display: none;">
          </label>
        </div>

        <!-- Upload Progress -->
        <div class="upload-progress" *ngIf="uploadProgress !== null">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="uploadProgress"></div>
          </div>
          <span class="progress-text">{{ uploadProgress }}%</span>
        </div>
      </div>
    </aside>

    <!-- Main Editor Area -->
    <div class="editor-main">
      <!-- Title Input -->
      <div class="form-group">
        <input type="text" class="form-control title-input" formControlName="title"
          [placeholder]="'NOTES.EDITOR.TITLE_PLACEHOLDER' | translate"
          [class.invalid]="titleControl?.invalid && titleControl?.touched">
        <div class="error-message" *ngIf="titleControl?.invalid && titleControl?.touched">
          <span *ngIf="titleControl?.errors?.['required']">{{ 'NOTES.EDITOR.ERRORS.TITLE_REQUIRED' | translate }}</span>
          <span *ngIf="titleControl?.errors?.['maxlength']">{{ 'NOTES.EDITOR.ERRORS.TITLE_MAX_LENGTH' | translate
            }}</span>
        </div>
      </div>

      <!-- Editor/Preview Container -->
      <div class="editor-preview-container" [class.split-view]="isSplitView">
        <!-- Markdown Editor -->
        <div class="markdown-editor" *ngIf="!isPreviewMode">
          <textarea class="form-control markdown-textarea" formControlName="markdown"
            [placeholder]="'NOTES.EDITOR.MARKDOWN_PLACEHOLDER' | translate"
            [class.invalid]="markdownControl?.invalid && markdownControl?.touched">
          </textarea>
          <div class="error-message" *ngIf="markdownControl?.invalid && markdownControl?.touched">
            <span *ngIf="markdownControl?.errors?.['required']">{{ 'NOTES.EDITOR.ERRORS.CONTENT_REQUIRED' | translate
              }}</span>
          </div>
        </div>

        <!-- Markdown Preview -->
        <div class="markdown-preview" *ngIf="isPreviewMode || isSplitView">
          <div class="preview-label">{{ 'NOTES.EDITOR.PREVIEW_LABEL' | translate }}</div>
          <div class="preview-content markdown-body" [innerHTML]="markdownPreview">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
