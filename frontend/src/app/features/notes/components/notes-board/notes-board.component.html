<div class="board-container">
  
  <div class="board-header">
    <h1>{{ 'NOTES.BOARD.TITLE' | translate }}</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="router.navigate(['/notes'])">
        <i class="bi bi-list"></i> {{ 'NOTES.BOARD.BUTTONS.LIST_VIEW' | translate }}
      </button>
      <button class="btn btn-primary" (click)="openGroupModal()">
        <i class="bi bi-plus-lg"></i> {{ 'NOTES.BOARD.BUTTONS.NEW_GROUP' | translate }}
      </button>
    </div>
  </div>

  <div class="loading" *ngIf="isLoading">
    <div class="spinner-border text-primary"></div>
    <p>{{ 'NOTES.BOARD.LOADING' | translate }}</p>
  </div>

  <div class="alert alert-danger" *ngIf="errorMessage && !isLoading">
    {{ errorMessage }}
    <button class="btn btn-sm btn-outline-danger ms-2" (click)="loadBoard()">{{ 'NOTES.LIST.BUTTONS.RETRY' | translate
      }}</button>
  </div>

  <div class="board-wrapper" *ngIf="!isLoading && !errorMessage" cdkDropList cdkDropListOrientation="horizontal"
    [cdkDropListData]="groups" (cdkDropListDropped)="onGroupsDrop($event)">
    <div class="board-columns" cdkDropListGroup>
      
      <div class="column">
        <div class="column-header">
          <h3 class="column-title">{{ 'NOTES.BOARD.COLUMNS.NO_GROUP' | translate }}</h3>
          <span class="column-count">{{ ungroupedNotes.length }}</span>
        </div>
        <div class="column-content" cdkDropList [id]="getListId(null)" [cdkDropListData]="ungroupedNotes"
          [cdkDropListConnectedTo]="getDropListIds()" (cdkDropListDropped)="onNoteDrop($event, null)">
          <div *ngFor="let note of ungroupedNotes" class="card" cdkDrag [cdkDragData]="note"
            (click)="openNote(note.id)">
            <div class="card-placeholder" *cdkDragPlaceholder></div>
            <h4 class="card-title">{{ note.title }}</h4>
            <p class="card-preview">{{ getPreview(note.markdown) }}</p>
            <div class="card-tags">
              <span *ngFor="let tag of note.tags.slice(0, 2)" class="tag-badge"
                [style.--tag-color]="getTagColor(tag)">
                {{ tag.name }}
              </span>
              <span class="tag-badge more" *ngIf="note.tags.length > 2">
                +{{ note.tags.length - 2 }}
              </span>
            </div>
          </div>
          <div class="empty-state" *ngIf="ungroupedNotes.length === 0">
            <p>{{ 'NOTES.BOARD.COLUMNS.EMPTY_UNGROUPED' | translate }}</p>
          </div>
        </div>
      </div>

      <div *ngFor="let group of groups" class="column" cdkDrag>
        <div class="column-header" [style.border-color]="getGroupColor(group)">
          <div class="column-left">
            <span class="drag-handle">⋮⋮</span>
            <h3 class="column-title">{{ group.title }}</h3>
            <span class="column-count">{{ getNotesForGroup(group.id).length }}</span>
          </div>
          <div class="column-actions">
            <button class="btn-icon" (click)="openGroupModal(group)" [title]="'NOTES.BOARD.ACTIONS.EDIT' | translate">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn-icon" (click)="deleteGroup(group.id)" [title]="'NOTES.BOARD.ACTIONS.DELETE' | translate">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
        <div class="column-content" cdkDropList [id]="getListId(group.id)"
          [cdkDropListData]="getNotesForGroup(group.id)" [cdkDropListConnectedTo]="getDropListIds()"
          (cdkDropListDropped)="onNoteDrop($event, group.id)">
          <div *ngFor="let note of getNotesForGroup(group.id)" class="card" cdkDrag [cdkDragData]="note"
            (click)="openNote(note.id)">
            <div class="card-placeholder" *cdkDragPlaceholder></div>
            <h4 class="card-title">{{ note.title }}</h4>
            <p class="card-preview">{{ getPreview(note.markdown) }}</p>
            <div class="card-tags">
              <span *ngFor="let tag of note.tags.slice(0, 2)" class="tag-badge"
                [style.--tag-color]="getTagColor(tag)">
                {{ tag.name }}
              </span>
              <span class="tag-badge more" *ngIf="note.tags.length > 2">
                +{{ note.tags.length - 2 }}
              </span>
            </div>
          </div>
          <div class="empty-state" *ngIf="getNotesForGroup(group.id).length === 0">
            <p>{{ 'NOTES.BOARD.COLUMNS.DROP_HERE' | translate }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showGroupModal" (click)="closeGroupModal()">
  <div class="modal-content" appFocusTrap role="dialog" aria-labelledby="group-modal-title" aria-modal="true"
    (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 id="group-modal-title">{{ (editingGroup ? 'NOTES.BOARD.MODAL.TITLE_EDIT' : 'NOTES.BOARD.MODAL.TITLE_NEW') |
        translate }}</h2>
      <button class="btn-close" aria-label="Close dialog" (click)="closeGroupModal()">
        ✖
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="group-title-input">{{ 'NOTES.BOARD.MODAL.LABEL_TITLE' | translate }}</label>
        <input id="group-title-input" type="text" class="form-control" [(ngModel)]="groupForm.title"
          [placeholder]="'NOTES.BOARD.MODAL.PLACEHOLDER_TITLE' | translate" />
      </div>
      <div class="form-group">
        <label>{{ 'NOTES.BOARD.MODAL.LABEL_COLOR' | translate }}</label>
        <div class="color-picker" role="group" aria-label="Group color selection">
          <button *ngFor="let color of predefinedColors" type="button" class="color-btn"
            [class.selected]="groupForm.color === color" [style.background-color]="getButtonColor(color)"
            [attr.aria-label]="'Select color ' + color" [attr.aria-pressed]="groupForm.color === color"
            (click)="groupForm.color = color"></button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeGroupModal()">{{ 'NOTES.BOARD.MODAL.CANCEL' | translate
        }}</button>
      <button class="btn btn-primary" (click)="saveGroup()">{{ 'NOTES.BOARD.MODAL.SAVE' | translate }}</button>
    </div>
  </div>
</div>
